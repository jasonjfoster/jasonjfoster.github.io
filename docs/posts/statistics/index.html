<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jason Foster">
<meta name="dcterms.date" content="2024-09-03">

<title>jasonjfoster.github.io - Statistics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">jasonjfoster.github.io</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jasonjfoster"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Statistics</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">algorithms</div>
                <div class="quarto-category">r</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="mailto:jason.j.foster@gmail.com">Jason Foster</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 3, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#usage" id="toc-usage" class="nav-link active" data-scroll-target="#usage">Usage</a></li>
  <li><a href="#rolling-any" id="toc-rolling-any" class="nav-link" data-scroll-target="#rolling-any">Rolling any</a></li>
  <li><a href="#rolling-all" id="toc-rolling-all" class="nav-link" data-scroll-target="#rolling-all">Rolling all</a></li>
  <li><a href="#rolling-sums" id="toc-rolling-sums" class="nav-link" data-scroll-target="#rolling-sums">Rolling sums</a></li>
  <li><a href="#rolling-products" id="toc-rolling-products" class="nav-link" data-scroll-target="#rolling-products">Rolling products</a></li>
  <li><a href="#rolling-means" id="toc-rolling-means" class="nav-link" data-scroll-target="#rolling-means">Rolling means</a></li>
  <li><a href="#rolling-minimums" id="toc-rolling-minimums" class="nav-link" data-scroll-target="#rolling-minimums">Rolling minimums</a></li>
  <li><a href="#rolling-maximums" id="toc-rolling-maximums" class="nav-link" data-scroll-target="#rolling-maximums">Rolling maximums</a></li>
  <li><a href="#rolling-index-of-minimums" id="toc-rolling-index-of-minimums" class="nav-link" data-scroll-target="#rolling-index-of-minimums">Rolling index of minimums</a></li>
  <li><a href="#rolling-index-of-maximums" id="toc-rolling-index-of-maximums" class="nav-link" data-scroll-target="#rolling-index-of-maximums">Rolling index of maximums</a></li>
  <li><a href="#rolling-medians" id="toc-rolling-medians" class="nav-link" data-scroll-target="#rolling-medians">Rolling medians</a></li>
  <li><a href="#rolling-quantiles" id="toc-rolling-quantiles" class="nav-link" data-scroll-target="#rolling-quantiles">Rolling quantiles</a></li>
  <li><a href="#rolling-variances" id="toc-rolling-variances" class="nav-link" data-scroll-target="#rolling-variances">Rolling variances</a></li>
  <li><a href="#rolling-standard-deviations" id="toc-rolling-standard-deviations" class="nav-link" data-scroll-target="#rolling-standard-deviations">Rolling standard deviations</a></li>
  <li><a href="#rolling-scaling-and-centering" id="toc-rolling-scaling-and-centering" class="nav-link" data-scroll-target="#rolling-scaling-and-centering">Rolling scaling and centering</a></li>
  <li><a href="#rolling-covariances" id="toc-rolling-covariances" class="nav-link" data-scroll-target="#rolling-covariances">Rolling covariances</a></li>
  <li><a href="#rolling-correlations" id="toc-rolling-correlations" class="nav-link" data-scroll-target="#rolling-correlations">Rolling correlations</a></li>
  <li><a href="#rolling-crossproducts" id="toc-rolling-crossproducts" class="nav-link" data-scroll-target="#rolling-crossproducts">Rolling crossproducts</a></li>
  <li><a href="#rolling-linear-models" id="toc-rolling-linear-models" class="nav-link" data-scroll-target="#rolling-linear-models">Rolling linear models</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<!---# https://github.com/quarto-dev/quarto-cli/issues/6092 -->
<p><a href="https://github.com/jasonjfoster/roll/actions"><img src="https://github.com/jasonjfoster/roll/workflows/R-CMD-check/badge.svg" class="img-fluid"></a> <a href="https://cran.r-project.org/package=roll"><img src="https://www.r-pkg.org/badges/version/roll" class="img-fluid"></a> <a href="https://codecov.io/github/jasonjfoster/roll"><img src="https://codecov.io/gh/jasonjfoster/roll/graph/badge.svg" class="img-fluid"></a> <a href="https://cranlogs.r-pkg.org/badges/last-day/roll"><img src="https://cranlogs.r-pkg.org/badges/last-day/roll?color=brightgreen" class="img-fluid"></a> <a href="https://cranlogs.r-pkg.org/badges/last-week/roll"><img src="https://cranlogs.r-pkg.org/badges/last-week/roll?color=brightgreen" class="img-fluid"></a> <a href="https://cranlogs.r-pkg.org/badges/roll"><img src="https://cranlogs.r-pkg.org/badges/roll?color=brightgreen" class="img-fluid"></a> <a href="https://cranlogs.r-pkg.org/badges/grand-total/roll"><img src="https://cranlogs.r-pkg.org/badges/grand-total/roll?color=brightgreen" class="img-fluid"></a></p>
<section id="usage" class="level1">
<h1>Usage</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(roll)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">microbenchmark.unit =</span> <span class="st">"us"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n_vars <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>weights <span class="ot">&lt;-</span> <span class="fl">0.9</span> <span class="sc">^</span> (n_obs<span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n_obs <span class="sc">*</span> n_vars), <span class="at">nrow =</span> n_obs, <span class="at">ncol =</span> n_vars)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n_obs), <span class="at">nrow =</span> n_obs, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>x_lgl <span class="ot">&lt;-</span> x <span class="sc">&lt;</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="rolling-any" class="level1">
<h1>Rolling any</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_any</span>(x_lgl, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_any</span>(x_lgl, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_any</span>(x_lgl, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_any</span>(x_lgl, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq    max neval
  125 160.9 210.45 225.157 227.05 242.80  303.9   100
  250 160.7 210.35 227.449 226.90 244.40  302.8   100
  500 169.5 204.85 236.194 225.50 240.90 1421.1   100
 1000 160.4 205.50 224.007 223.00 238.45  307.2   100</code></pre>
</div>
</div>
</section>
<section id="rolling-all" class="level1">
<h1>Rolling all</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_all</span>(x_lgl, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_all</span>(x_lgl, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_all</span>(x_lgl, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_all</span>(x_lgl, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 137.4 185.30 204.797  195.9 216.95 562.7   100
  250 131.6 182.95 201.571  195.2 213.55 405.2   100
  500 135.9 160.85 194.725  189.7 205.60 703.6   100
 1000 132.7 165.50 190.231  186.8 201.20 427.8   100</code></pre>
</div>
</div>
</section>
<section id="rolling-sums" class="level1">
<h1>Rolling sums</h1>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{Expanding window} \\
&amp;\bullet\text{sum}_{x}\leftarrow\lambda\times\text{sum}_{x}+\text{w}_{new}\times\text{x}_{new}\\
&amp;\text{Rolling window}\\
&amp;\bullet\text{sum}_{x}\leftarrow\lambda\times\text{sum}_{x}+\text{w}_{new}\times\text{x}_{new}-\lambda\times\text{w}_{old}\times\text{x}_{old}
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_sum</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_sum</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_sum</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_sum</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 143.0 171.40 207.560 176.35 216.25 420.3   100
  250 149.4 169.15 194.926 172.10 188.45 377.3   100
  500 163.1 169.60 202.515 174.15 194.55 506.0   100
 1000 158.5 167.35 199.093 172.75 207.70 411.8   100</code></pre>
</div>
</div>
</section>
<section id="rolling-products" class="level1">
<h1>Rolling products</h1>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{Expanding window}\\
&amp;\bullet\text{prod}_{w}\leftarrow\text{prod}_{w}\times\text{w}_{new}\\
&amp;\bullet\text{prod}_{x}\leftarrow\text{prod}_{x}\times\text{x}_{new}\\
&amp;\text{Rolling window}\\
&amp;\bullet\text{prod}_{x}\leftarrow\text{prod}_{x}\times\text{x}_{new}/\text{x}_{old}
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_prod</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_prod</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_prod</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_prod</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 361.8 403.35 416.038 411.00 419.45 529.8   100
  250 373.3 406.35 419.907 412.60 422.45 577.6   100
  500 271.9 311.00 323.145 317.35 323.40 430.1   100
 1000 280.8 306.55 318.957 314.05 323.50 438.0   100</code></pre>
</div>
</div>
</section>
<section id="rolling-means" class="level1">
<h1>Rolling means</h1>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{Expanding window}\\
&amp;\bullet\text{sum}_{w}\leftarrow\text{sum}_{w}+\text{w}_{new}\\
&amp;\bullet\text{sum}_{x}\leftarrow\lambda\times\text{sum}_{x}+\text{w}_{new}\times\text{x}_{new}\\
&amp;\text{Rolling window}\\
&amp;\bullet\text{sum}_{x}\leftarrow\lambda\times\text{sum}_{x}+\text{w}_{new}\times\text{x}_{new}-\lambda\times\text{w}_{old}\times \text{x}_{old}
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_mean</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_mean</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_mean</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_mean</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median    uq   max neval
  125 168.7 177.30 217.510 194.95 230.0 546.2   100
  250 167.8 177.80 203.228 186.50 207.3 404.9   100
  500 166.9 174.30 199.355 184.35 198.4 399.7   100
 1000 163.5 172.75 200.761 182.80 198.1 524.7   100</code></pre>
</div>
</div>
</section>
<section id="rolling-minimums" class="level1">
<h1>Rolling minimums</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_min</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_min</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_min</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_min</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 179.0 185.05 209.814 189.40 207.05 354.6   100
  250 179.7 185.30 213.086 191.35 226.25 350.6   100
  500 177.0 185.90 216.048 191.60 225.10 410.1   100
 1000 181.0 187.05 222.525 196.40 235.40 468.4   100</code></pre>
</div>
</div>
</section>
<section id="rolling-maximums" class="level1">
<h1>Rolling maximums</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_max</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_max</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_max</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_max</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 178.0 184.75 229.956 193.05 284.40 335.6   100
  250 178.1 183.30 232.462 191.75 297.20 467.6   100
  500 178.2 184.35 233.055 190.75 295.15 380.1   100
 1000 176.0 184.00 227.080 192.95 266.00 365.6   100</code></pre>
</div>
</div>
</section>
<section id="rolling-index-of-minimums" class="level1">
<h1>Rolling index of minimums</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_idxmin</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_idxmin</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_idxmin</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_idxmin</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 165.5 312.00 324.729 334.40 345.95 547.0   100
  250 150.5 301.70 321.277 331.10 344.00 456.7   100
  500 206.5 306.45 325.543 332.00 343.45 394.8   100
 1000 210.5 311.60 325.476 331.45 342.75 439.9   100</code></pre>
</div>
</div>
</section>
<section id="rolling-index-of-maximums" class="level1">
<h1>Rolling index of maximums</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_idxmax</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_idxmax</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_idxmax</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_idxmax</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 146.1 163.55 184.542 171.15 196.65 307.3   100
  250 147.3 162.95 186.971 168.40 192.55 299.2   100
  500 149.7 165.05 189.127 169.90 198.05 294.3   100
 1000 146.6 162.90 183.829 168.00 185.05 459.5   100</code></pre>
</div>
</div>
</section>
<section id="rolling-medians" class="level1">
<h1>Rolling medians</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># "'online' is only supported for equal 'weights'"</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_median</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_median</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_median</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_median</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr    min      lq     mean  median      uq    max neval
  125 1106.0 1155.80 1895.729 2377.50 2436.80 7037.3   100
  250 1093.8 1156.15 1928.678 2393.15 2423.70 3192.6   100
  500 1007.8 1115.35 1870.322 2234.75 2264.20 3968.0   100
 1000  781.9  839.45 1366.839 1677.00 1753.55 6034.3   100</code></pre>
</div>
</div>
</section>
<section id="rolling-quantiles" class="level1">
<h1>Rolling quantiles</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># "'online' is only supported for equal 'weights'"</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_quantile</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_quantile</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_quantile</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_quantile</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr    min      lq     mean  median      uq    max neval
  125 1092.9 1241.90 1757.977 1492.45 2413.75 2586.1   100
  250 1093.4 1234.00 1712.951 1308.45 2410.05 2600.6   100
  500 1007.3 1159.45 1757.193 1942.30 2241.90 3671.6   100
 1000  788.3  887.90 1256.679  949.20 1736.35 3542.0   100</code></pre>
</div>
</div>
</section>
<section id="rolling-variances" class="level1">
<h1>Rolling variances</h1>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{Expanding window}\\
&amp;\bullet\text{sum}_{w}\leftarrow\text{sum}_{w}+\text{w}_{new}\\
&amp;\bullet\text{sumsq}_{w}\leftarrow\text{sumsq}_{w}+\text{w}_{new}^{2}\\
&amp;\bullet\text{sumsq}_{x}\leftarrow\lambda\times\text{sumsq}_{x}+\text{w}_{new}\times (\text{x}_{new}-\text{mean}_{x})(\text{x}_{new}-\text{mean}_{prev_x})\\
&amp;\text{Rolling window}\\
&amp;\bullet\text{sumsq}_{x}\leftarrow\lambda\times\text{sumsq}_{x}+\text{w}_{new}\times (\text{x}_{new}-\text{mean}_{x})(\text{x}_{new}-\text{mean}_{prev_x})-\\
&amp;\lambda\times\text{w}_{old}\times (\text{x}_{old}-\text{mean}_{x})(\text{x}_{old}-\text{mean}_{prev_x})
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_var</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_var</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_var</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_var</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 184.9 220.05 249.454 239.70 269.35 542.8   100
  250 179.9 212.80 238.077 225.75 252.40 377.4   100
  500 171.4 206.45 234.577 222.80 253.15 357.2   100
 1000 162.7 197.65 223.355 209.65 235.30 366.6   100</code></pre>
</div>
</div>
</section>
<section id="rolling-standard-deviations" class="level1">
<h1>Rolling standard deviations</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_sd</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_sd</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_sd</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_sd</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median     uq   max neval
  125 191.4 218.05 241.662 228.25 256.55 372.5   100
  250 185.2 224.00 245.282 239.80 260.05 370.3   100
  500 179.3 217.40 240.162 230.80 258.95 475.3   100
 1000 168.9 209.35 234.939 222.00 247.05 380.2   100</code></pre>
</div>
</div>
</section>
<section id="rolling-scaling-and-centering" class="level1">
<h1>Rolling scaling and centering</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_scale</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_scale</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_scale</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_scale</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min     lq    mean median    uq   max neval
  125 231.9 256.20 293.843 287.50 315.8 548.2   100
  250 231.7 262.65 300.428 300.05 319.2 497.5   100
  500 223.4 256.15 286.067 283.50 308.2 452.7   100
 1000 215.3 250.60 277.198 274.65 291.9 489.0   100</code></pre>
</div>
</div>
</section>
<section id="rolling-covariances" class="level1">
<h1>Rolling covariances</h1>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{Expanding window}\\
&amp;\bullet\text{sum}_{w}\leftarrow\text{sum}_{w}+\text{w}_{new}\\
&amp;\bullet\text{sumsq}_{w}\leftarrow\text{sumsq}_{w}+\text{w}_{new}^{2}\\
&amp;\bullet\text{sumsq}_{xy}\leftarrow\lambda\times\text{sumsq}_{xy}+\text{w}_{new}\times (\text{x}_{new}-\text{mean}_{x})(\text{y}_{new}-\text{mean}_{prev_y})\\
&amp;\text{Rolling window}\\
&amp;\bullet\text{sumsq}_{xy}\leftarrow\lambda\times\text{sumsq}_{xy}+\text{w}_{new}\times (\text{x}_{new}-\text{mean}_{x})(\text{y}_{new}-\text{mean}_{prev_y})-\\
&amp;\lambda\times\text{w}_{old}\times (\text{x}_{old}-\text{mean}_{x})(\text{y}_{old}-\text{mean}_{prev_y})
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_cov</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_cov</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_cov</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_cov</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr    min     lq     mean  median     uq     max neval
  125 1115.0 1442.8 2169.993 1735.65 2797.4 10252.2   100
  250 1159.9 1464.2 2178.417 1772.10 2808.6 10593.0   100
  500 1112.7 1392.0 2349.207 1755.15 2769.8 16375.8   100
 1000 1035.9 1303.1 1973.997 1563.30 2631.3  9309.9   100</code></pre>
</div>
</div>
</section>
<section id="rolling-correlations" class="level1">
<h1>Rolling correlations</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_cor</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_cor</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_cor</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_cor</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr    min      lq     mean  median      uq     max neval
  125 1245.8 1617.25 2858.002 1944.85 3499.30 23031.0   100
  250 1241.5 1600.25 2575.015 2958.40 3451.55  4397.5   100
  500 1153.9 1512.10 2472.486 1798.40 3151.95 18482.9   100
 1000 1102.2 1313.45 2129.618 1486.20 2799.55  7950.0   100</code></pre>
</div>
</div>
</section>
<section id="rolling-crossproducts" class="level1">
<h1>Rolling crossproducts</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_crossprod</span>(x, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_crossprod</span>(x, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_crossprod</span>(x, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_crossprod</span>(x, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr   min      lq     mean  median      uq    max neval
  125 876.0 1060.75 1213.893 1133.65 1215.95 8335.5   100
  250 863.1 1033.35 1133.879 1117.05 1182.10 1576.9   100
  500 838.7  997.20 1194.046 1032.60 1104.20 7913.5   100
 1000 759.3  899.45 1096.463  935.85  987.30 9894.1   100</code></pre>
</div>
</div>
</section>
<section id="rolling-linear-models" class="level1">
<h1>Rolling linear models</h1>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{coef}=\text{cov}_{xx}^{-1}\times\text{cov}_{xy}\\
&amp;\text{intercept}=\text{mean}_{y}-\text{coef}\times\text{mean}_{x}\\
&amp;\text{rsq}=\frac{\text{coef}^{T}\times\text{cov}_{xx}\times\text{coef}}{\text{var}_{y}}\\
&amp;\text{var}_{resid}=\frac{(1-\text{rsq})(\text{var}_{y})(\text{sum}_{w}-\text{sumsq}_{w}/\text{sum}_{w})}{\text{n}_{rows}-\text{n}_{cols}}\\
&amp;\text{xx}=\text{cov}_{xx}\times(\text{sum}_{w}-\text{sumsq}_{w}/\text{sum}_{w})\\
&amp;\text{se}_{coef}=\sqrt{\text{var}_{resid}\times\text{diag}(\text{xx}^{-1})}\\
&amp;\text{se}_{intercept}=\sqrt{\text{var}_{resid}\left(1/\text{sum}_{w}+\text{mean}_{x}^{T}\text{xx}^{-1}\text{mean}_{x}\right)}
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="st">"125"</span> <span class="ot">=</span> <span class="fu">roll_lm</span>(x, y, <span class="at">width =</span> <span class="dv">125</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"250"</span> <span class="ot">=</span> <span class="fu">roll_lm</span>(x, y, <span class="at">width =</span> <span class="dv">250</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"500"</span> <span class="ot">=</span> <span class="fu">roll_lm</span>(x, y, <span class="at">width =</span> <span class="dv">500</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"1000"</span> <span class="ot">=</span> <span class="fu">roll_lm</span>(x, y, <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">min_obs =</span> <span class="dv">1</span>, <span class="at">weights =</span> weights))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr    min      lq     mean  median      uq     max neval
  125 3124.8 5772.10 6766.359 7290.90 7761.45 11977.2   100
  250 3051.4 4143.45 6775.036 7259.90 7763.80 23820.0   100
  500 3037.0 4606.40 6693.170 7043.70 7587.85 24452.2   100
 1000 2793.5 6057.40 6808.074 7016.25 7756.85 27020.3   100</code></pre>
</div>
</div>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li>Weights: <a href="https://stackoverflow.com/a/9933794" class="uri">https://stackoverflow.com/a/9933794</a></li>
<li>Index: <a href="https://stackoverflow.com/a/11316626" class="uri">https://stackoverflow.com/a/11316626</a></li>
<li>Index: <a href="https://stackoverflow.com/a/34363187" class="uri">https://stackoverflow.com/a/34363187</a></li>
<li>Index: <a href="https://stackoverflow.com/a/243342" class="uri">https://stackoverflow.com/a/243342</a></li>
<li>Quantile (comparator): <a href="https://stackoverflow.com/a/51992954" class="uri">https://stackoverflow.com/a/51992954</a></li>
<li>Quantile (comparator): <a href="https://stackoverflow.com/a/25921772" class="uri">https://stackoverflow.com/a/25921772</a></li>
<li>Quantile (comparator): <a href="https://stackoverflow.com/a/40416506" class="uri">https://stackoverflow.com/a/40416506</a></li>
<li>Median: <a href="https://stackoverflow.com/a/5970314" class="uri">https://stackoverflow.com/a/5970314</a></li>
<li>Median: <a href="https://stackoverflow.com/a/5971248" class="uri">https://stackoverflow.com/a/5971248</a></li>
<li>Median: <a href="https://gist.github.com/ashelly/5665911" class="uri">https://gist.github.com/ashelly/5665911</a></li>
<li>Standard errors: <a href="https://stats.stackexchange.com/a/64217" class="uri">https://stats.stackexchange.com/a/64217</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>