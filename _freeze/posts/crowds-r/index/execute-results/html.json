{
  "hash": "a7862b01dd5b26140805d7c629465c25",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Crowds\"\nauthor: \"[Jason Foster](mailto:jason.j.foster@gmail.com)\"\ndate: last-modified\ncategories:\n  - analysis\n  - finance\n  - r\ndraft: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(xml2)\nlibrary(quantmod)\nlibrary(roll)\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfactors_r <- c(\"SP500\") # \"SP500\" does not contain dividends\nfactors_d <- c(\"SOFR\")\nfactors <- c(factors_r, factors_d)\nwidth <- 20 * 3\nscale <- list(\"periods\" = 252, \"overlap\" = 5)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngetSymbols(factors, src = \"FRED\")\nlevels_xts <- do.call(merge, c(lapply(factors, function(i) get(i)), all = TRUE))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nreturns_xts <- do.call(merge, lapply(factors, function(i) {\n    if (i %in% factors_r) {\n        diff(log((levels_xts[ , i])))\n    } else if (i %in% factors_d) {\n        -diff(levels_xts[ , i]) / 100\n    }    \n}))\noverlap_xts <- roll_mean(returns_xts, scale[[\"overlap\"]], min_obs = 1, na_restore = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(CVXR)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nget_nth <- function(x, n, offset = 0) {\n  \n  result <- x[seq(offset + 1, length(x), by = n)]\n  \n  return(result)\n  \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nget_mstar <- function() {\n  \n  i <- 0\n  status <- TRUE\n  names_ls <- list()\n  tickers_ls <- list()\n  types_ls <- list()\n  \n  while(status) {\n    \n    i <- i + 1\n    \n    response <- read_html(paste0(\"https://www.morningstar.com/asset-allocation-funds?page=\", i))\n    \n    table <- xml_find_all(response, \".//div[@class='topic__table-container']\")\n    \n    if (length(table) == 0) {\n      status <- FALSE\n    } else {\n      \n      names_tickers <- xml_text(xml_find_all(response, \".//a[@class='mdc-link mds-link mds-link--data-table mdc-link--no-visited']\"))\n      types <- xml_text(xml_find_all(response, \".//span[@class='mdc-data-point mdc-data-point--string mdc-string']\"))\n      \n      names_ls <- append(names_ls, list(get_nth(names_tickers, 2)))\n      tickers_ls <- append(tickers_ls, list(get_nth(names_tickers, 2, 1)))\n      types_ls <- append(types_ls, list(get_nth(types, 5, 2)))\n      \n    }\n    \n  }\n  \n  result <- data.frame(\"name\" = do.call(c, names_ls),\n                       \"ticker\" = do.call(c, tickers_ls),\n                       \"type\" = do.call(c, types_ls))\n  \n  return(result)\n  \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmstar_df <- get_mstar()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntickers <- mstar_df[mstar_df$type == \"Tactical Allocation\", \"ticker\"]\ninvisible(getSymbols(tickers, src = \"tiingo\", api.key = Sys.getenv(\"TIINGO_API_KEY\"), adjust = TRUE))\nprices_xts <- do.call(merge, c(lapply(tickers, function(i) Cl(get(i))), all = TRUE))\ncolnames(prices_xts) <- tickers\nindex(prices_xts) <- as.Date(index(prices_xts))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nreturns_xts <- merge(returns_xts, diff(log(prices_xts)))\noverlap_xts <- merge(overlap_xts, roll_mean(returns_xts[ , tickers], scale[[\"overlap\"]], min_obs = 1))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\noverlap_xts <- na.omit(overlap_xts)\noverlap_x_xts <- tail(overlap_xts[ , factors], width)\noverlap_y_xts <- tail(overlap_xts[ , tickers], width)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npnl <- function(x) {\n  \n  return(prod(1 + x) - 1)\n  \n}\n```\n:::\n\n\n# Optimization\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmin_rss_optim <- function(x, y) {\n    \n    params <- Variable(ncol(x))\n    \n    obj <- Minimize(sum_squares(y - x %*% params))\n    \n    cons <- list(sum(params) == 1, params >= 0, params <= 1)\n    \n    prob <- Problem(obj, cons)\n        \n    result <- solve(prob)$getValue(params)\n    \n    return(result)\n\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# n_rows <- nrow(overlap_xts)\nresult_ls <- list()\n\n# for (i in width:n_rows) {\nfor (i in width) {\n    \n    idx <- max(i - width + 1, 1):i\n    x_subset <- overlap_x_xts[idx, ]\n    y_subset <- overlap_y_xts[idx, ]\n    params_ls <- list()\n    \n    for (j in tickers) {\n        \n        params <- t(min_rss_optim(coredata(x_subset), coredata(y_subset[ , j])))\n        params_ls <- append(params_ls, list(params))\n        \n    }\n    \n    result <- colMeans(do.call(rbind, params_ls))\n    result_ls <- append(result_ls, list(result))\n    \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nposition <- do.call(rbind, result_ls)\n# position_xts <- xts(position, index(overlap_xts)[width:n_rows])\nposition_xts <- xts(position, tail(index(overlap_xts), 1))\ncolnames(position_xts) <- factors\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntail(position_xts)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n               SP500      SOFR\n2024-02-12 0.6711158 0.3288842\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}